---
title: Microsoft identity platform Android quickstart | Azure
description: Learn how Android applications can call an API that require access tokens by Microsoft identity platform endpoint.
services: active-directory
documentationcenter: dev-center-name
author: TylerMSFT
manager: CelesteDG
editor: ''

ms.service: active-directory
ms.subservice: develop
ms.devlang: na
ms.topic: quickstart
ms.tgt_pltfrm: na
ms.workload: identity
ms.date: 09/13/2019
ms.author: twhitney
ms.custom: aaddev, identityplatformtop40
#Customer intent: As an application developer, I want to learn how Android native apps can call protected APIs that require login and access tokens using the Microsoft identity platform endpoint.
ms.collection: M365-identity-device-management
---

# Quickstart: Sign in users and call the Microsoft Graph API from an Android app

This quickstart uses a code sample to demonstrate how an Android application can sign in personal or work and school accounts, get an access token, and call the Microsoft Graph API.

![Shows how the sample app generated by this quickstart works](media/quickstart-v2-android/android-intro.svg)

> [!NOTE]
> **Prerequisites**
> * Android Studio 
> * Android 16+ is required 

## Download and run the app

1. [Download and extract the Code Sample](https://github.com/Azure-Samples/active-directory-android-native-v2/archive/master.zip)
1. In Android Studio, open the project from the location you downloaded it, for examples, c:\users\<you>\downloads\azuresamples
1. Select your emulator or device from Android Studio's **available devices** dropdown, and click the Run button.

The sample app starts on the **Single Account Mode** screen. A default scope, **user.read**, is provided by default which is used when reading your own profile data during the Microsoft Graph API call. The URL for the Microsoft Graph API call is provided by default. You can change both of these if you wish.

![MSAL sample app showing single and multiple account usage](./media/quickstart-v2-android/quickstart-sample-app.png)

Use the app menu to change between single and multiple account mode.

In single account mode, you can sign in using a work or home account:

1. Select **Get graph data interactively** to prompt the user for their credentials. You'll see the output from the call to the Microsoft Graph API in the bottom of the screen.
2. Once signed in, select **Get graph data silently** to make a call to the Microsoft Graph API without re-prompting the user for credentials. You'll see the output from the call to the Microsoft Graph API in the bottom of the screen.

In multiple account mode, you can repeat the same steps.  Additionally, you can remove the signed-in account, along with cached tokens for that account.

## How the sample works

The code is organized into fragments that show how to write a single and multiple account MSAL app. The code files are organized as follows:

| File  | Demonstrates  |
|---------|---------|
| MainActivity | Manages the UI |
| MSGraphRequestWrapper  | Calls the Microsoft Graph API using the token provided by MSAL |
| MultipleAccountModeFragment  | Initializes a multi-account application, loads a user account, and gets a token to call the Microsoft Graph API |
| SingleAccountModeFragment | Initializes a multi-account application, loads a user account, and gets a token to call the Microsoft Graph API |
| res/auth_config_multiple_account.json  | The multiple account configuration file |
| res/auth_config_single_account.json  | The single account configuration file |
| Gradle Scripts/build.grade (Module:app) | The MSAL library dependencies are added here |

We will now look at these files in more detail and call out the MSAL specific code in each.

### Add MSAL to the app

MSAL ([com.microsoft.identity.client](https://javadoc.io/doc/com.microsoft.identity.client/msal)) is the library used to sign in users and request tokens used to access an API protected by Microsoft identity platform. Gradle 3.0+ is installs the library when you add the following to **Gradle Scripts** > **build.gradle (Module: app)** under **Dependencies**:

```gradle  
implementation 'com.microsoft.identity.client:msal:1.0.0'
```

You can see this in the sample project in build.gradle (Module: app):

```java
dependencies {
    ...
    implementation 'com.android.volley:volley:1.1.1'
    externalImplementation 'com.microsoft.identity.client:msal:1.0.0'
}
```

The dependency on `implementation 'com.android.volley:volley:1.1.1'` is for communication with Microsoft Graph.

### MSAL Imports

The imports that are relevant to the MSAL library are `com.microsoft.identity.client.*`.  For example, you'll see `import com.microsoft.identity.client.PublicClientApplication;` which is the namespace for the PublicClientApplication class which represents your public client application.

The imports for `com.android.volley.*` are used as part of calling the Microsoft Graph API.

### SingleAccountModeFragment.java

This file demonstrates how to create a single account MSAL app and call a Microsoft Graph API.

#### Single account MSAL initialization

In `onCreateView()`, a single account `PublicClientApplication` is created using the config information stored in the `auth_config_single_account.json file`.  This is how you initialize the MSAL library for use in a single-account MSAL app:

    ```java
    // Creates a PublicClientApplication object with res/raw/auth_config_single_account.json
    PublicClientApplication.createSingleAccountPublicClientApplication(getContext(),
            R.raw.auth_config_single_account,
            new IPublicClientApplication.ISingleAccountApplicationCreatedListener() {
                @Override
                public void onCreated(ISingleAccountPublicClientApplication application) {
                    /**
                        * This test app assumes that the app is only going to support one account.
                        * This requires "account_mode" : "SINGLE" in the config json file.
                        **/
                    mSingleAccountApp = application;
                    loadAccount();
                }
    
                @Override
                public void onError(MsalException exception) {
                    logTextView.setText(exception.toString());
                }
            });
    ```

#### Sign in a user

The code to sign in a user is in `initializeUI()`, in the `signInButton` click handler. Note that signing in a user is an asynchronous operation. A callback is passed that calls the Microsoft Graph API and update the UI once the user signs in:

```java
signInButton.setOnClickListener(new View.OnClickListener() {
    public void onClick(View v) {
        ...
        mSingleAccountApp.signIn(getActivity(), null, getScopes(), getAuthInteractiveCallback());
    }
});
```

#### Sign out a user

The code to sign out a user is in `initializeUI()`, in the `signOutButton` click handler.  Note that signing a user out is an asynchronous operation. A callback is created to update the  UI once the user account is signed out:

```java
/**
    * Removes the signed-in account and cached tokens from this app (or device, if the device is in shared mode).
    */
mSingleAccountApp.signOut(new ISingleAccountPublicClientApplication.SignOutCallback() {
    @Override
    public void onSignOut() {
        updateUI(null);
        performOperationOnSignOut();
    }

    @Override
    public void onError(@NonNull MsalException exception) {
        displayError(exception);
    }
});
```

#### Get a token interactively or silently

Some situations require users to interact with Microsoft identity platform. In these cases, the user may need to select their account, enter their credentials, or consent to the permissions your app has requested. Some other situations when the user may be prompted are:

* The first time users sign in to the application
* If a user resets their password, they will need to enter their credentials 
* If consent is revoked 
* If your app explicitly requires consent. 
* When your application is requesting access to a resource for the first time
* When MFA or other Conditional Access policies are required

The code to get a token interactively, that is with UI that will involve the user, is in `initializeUI()`, in the `callGraphApiInteractiveButton` click handler:

```java
callGraphApiInteractiveButton.setOnClickListener(new View.OnClickListener() {
    public void onClick(View v) {
        
        ...

        /**
            * If acquireTokenSilent() returns an error that requires an interaction,
            * invoke acquireToken() to have the user resolve the interrupt interactively.
            *
            * Some example scenarios are
            *  - password change
            *  - the resource you're acquiring a token for has a stricter set of requirement than your SSO refresh token.
            *  - you're introducing a new scope which the user has never consented for.
            */
        mSingleAccountApp.acquireToken(getActivity(), getScopes(), getAuthInteractiveCallback());
    }
});
```

Apps shouldn't require their users to sign in every time they request a token. If the user has already signed in, `acquireTokenSilentAsync()` allows apps to request tokens silently as shown in `initializeUI()`, in the `callGraphApiSilentButton` click handler:

```java
callGraphApiSilentButton.setOnClickListener(new View.OnClickListener() {
    @Override
    public void onClick(View v) {
        ...

        /**
            * Once you've signed the user in,
            * you can perform acquireTokenSilent to obtain resources without interrupting the user.
            */
        mSingleAccountApp.acquireTokenSilentAsync(getScopes(), AUTHORITY, getAuthSilentCallback());
    }
});
```

#### Load an account

The code to load an account is in `loadAccount()`.  Loading the user's account is an asynchronous operation, so callbacks to handle when the account is loaded, changes, or an error occurs is passed to MSAL:

```java
private void loadAccount() {
    ...

    mSingleAccountApp.getCurrentAccountAsync(new ISingleAccountPublicClientApplication.CurrentAccountCallback() {
        @Override
        public void onAccountLoaded(@Nullable IAccount activeAccount) {
            updateUI(activeAccount);
        }

        @Override
        public void onAccountChanged(@Nullable IAccount priorAccount, @Nullable IAccount currentAccount) {
            if (currentAccount == null) {
                // Perform a cleanup task as the signed-in account changed.
                performOperationOnSignOut();
            }
        }

        @Override
        public void onError(@NonNull MsalException exception) {
            logTextView.setText(exception.toString());
        }
    });
}
```

#### Call Microsoft Graph

When a user is signed in, the call to Microsoft Graph is made via an HTTP request by `callGraphAPI()`. It passes the access token from the `authenticationResult` so that the token information can be embedded in the call to Microsoft Graph.  

```java
private void callGraphAPI(final IAuthenticationResult authenticationResult) {
    MSGraphRequestWrapper.callGraphAPIWithVolley(
            getContext(),
            graphResourceTextView.getText().toString(),
            authenticationResult.getAccessToken(),
            new Response.Listener<JSONObject>() {
                @Override
                public void onResponse(JSONObject response) {
                    /* Successfully called graph, process data and send to UI */
                    Log.d(TAG, "Response: " + response.toString());
                    displayGraphResult(response);
                }
            },
            new Response.ErrorListener() {
                @Override
                public void onErrorResponse(VolleyError error) {
                    Log.d(TAG, "Error: " + error.toString());
                    displayError(error);
                }
            });
}
```

### auth_config_single_account.json

This is the configuration file for a MSAL app that uses a single account.

See [Understand  the Android MSAL configuration file ](msal-configuration.md) for an explanation of these fields.

Note the presence of `"account_mode" : "SINGLE"` which configures this app for using a single account.

```json
{
  "client_id" : "0984a7b6-bc13-4141-8b0d-8f767e136bb7",
  "authorization_user_agent" : "DEFAULT",
  "redirect_uri" : "msauth://com.azuresamples.msalandroidapp/1wIqXSqBj7w%2Bh11ZifsnqwgyKrY%3D",
  "account_mode" : "SINGLE",
  "broker_redirect_uri_registered": true,
  "authorities" : [
    {
      "type": "AAD",
      "audience": {
        "type": "AzureADandPersonalMicrosoftAccount",
        "tenant_id": "common"
      }
    }
  ]
}
```

### MultipleAccountModeFragment.java

This file demonstrates how to create a multiple account MSAL app and call a Microsoft Graph API.

#### Multiple account MSAL initialization

In `onCreateView()`, a multiple account is created using the config information stored in the `auth_config_multiple_account.json file`:

```java
// Creates a PublicClientApplication object with res/raw/auth_config_single_account.json
PublicClientApplication.createMultipleAccountPublicClientApplication(getContext(),
        R.raw.auth_config_multiple_account,
        new IPublicClientApplication.IMultipleAccountApplicationCreatedListener() {
            @Override
            public void onCreated(IMultipleAccountPublicClientApplication application) {
                mMultipleAccountApp = application;
                loadAccount();
            }

            @Override
            public void onError(MsalException exception) {
                logTextView.setText(exception.getMessage());
                removeAccountButton.setEnabled(false);
                callGraphApiInteractiveButton.setEnabled(false);
                callGraphApiSilentButton.setEnabled(false);
            }
        });
```

Note that the created `MultipleAccountPublicClientApplication` object is stored in a class member variable so that it can be used to interact with the MSAL library to acquire tokens and load and remove the user account.

#### Get a token interactively or silently

Some situations require users to interact with Microsoft identity platform. In these cases, the user may need to select their account, enter their credentials, or consent to the permissions your app has requested. Some other situations when the user may be prompted are:

* The first time users sign in to the application
* If a user resets their password, they will need to enter their credentials 
* If consent is revoked 
* If your app explicitly requires consent. 
* When your application is requesting access to a resource for the first time
* When MFA or other Conditional Access policies are required

The code to get a token interactively, that is with UI that involves the user, is in `initializeUI()`, in the `callGraphApiInteractiveButton` click handler:

```java
callGraphApiInteractiveButton.setOnClickListener(new View.OnClickListener() {
    public void onClick(View v) {
        if (mMultipleAccountApp == null) {
            return;
        }

        /**
            * Acquire token interactively. It will also create an account object for the silent call as a result (to be obtained by getAccount()).
            *
            * If acquireTokenSilent() returns an error that requires an interaction,
            * invoke acquireToken() to have the user resolve the interrupt interactively.
            *
            * Some example scenarios are
            *  - password change
            *  - the resource you're acquiring a token for has a stricter set of requirement than your SSO refresh token.
            *  - you're introducing a new scope which the user has never consented for.
            */
        mMultipleAccountApp.acquireToken(getActivity(), getScopes(), getAuthInteractiveCallback());
    }
});
```

Apps shouldn't require their users to sign in every time they request a token. If the user has already signed in, `acquireTokenSilentAsync()` allows apps to request tokens without prompting the user, as shown in `initializeUI()` in the `callGraphApiSilentButton` click handler:

```java
callGraphApiSilentButton.setOnClickListener(new View.OnClickListener() {
    @Override
    public void onClick(View v) {
        ...

        /**
            * Performs acquireToken without interrupting the user.
            *
            * This requires an account object of the account you're obtaining a token for.
            * (can be obtained via getAccount()).
            */
        mMultipleAccountApp.acquireTokenSilentAsync(getScopes(),
                accountList.get(accountListSpinner.getSelectedItemPosition()),
                AUTHORITY,
                getAuthSilentCallback());
    }
});
```

#### Load an account

The code to load an account is in `loadAccount()`.  Loading the user's account is an asynchronous operation, so a callback to handle when the account is loaded, changes, or an error occurs is passed to MSAL to handle those situations:

```java
/**
    * Load the currently signed-in account, if there's any.
    * In the shared device mode, if the user is signed out from the device, the app can also perform the clean-up work in onAccountChanged().
    */
private void loadAccount() {
    ...

    mMultipleAccountApp.getAccounts(new IPublicClientApplication.LoadAccountsCallback() {
        @Override
        public void onTaskCompleted(final List<IAccount> result) {
            accountList = result;
            updateUI(accountList);
        }

        @Override
        public void onError(MsalException exception) {
            logTextView.setText(exception.toString());
        }
    });
}
```

#### Remove an account

The code to remove an account and any cached tokens for the account is in `initializeUI()` in the handler for the remove account button. Because removing an account is an asynchronous operation, the `onRemoved` callback is supplied to update the UI.

```java
/**
    * Removes the selected account and cached tokens from this app (or device, if the device is in shared mode).
    */
mMultipleAccountApp.removeAccount(accountList.get(accountListSpinner.getSelectedItemPosition()),
        new IMultipleAccountPublicClientApplication.RemoveAccountCallback() {
            @Override
            public void onRemoved() {
                Toast.makeText(getContext(), "Account removed.", Toast.LENGTH_SHORT)
                        .show();

                /* Reload account asynchronously to get the up-to-date list. */
                loadAccount();
            }

            @Override
            public void onError(@NonNull MsalException exception) {
                displayError(exception);
            }
        });
```

### auth_config_multiple_account.json

This is the configuration file for a MSAL app that uses multiple accounts.

See [Understand  the Android MSAL configuration file ](msal-configuration.md) for an explanation of these fields.

Note that unlike the [auth_config_multiple_account.json](#auth_config_multiple_account.json) configuration file, there is no `"account_mode" : "SINGLE"` because this is a multiple account app.

```json
{
  "client_id" : "0984a7b6-bc13-4141-8b0d-8f767e136bb7",
  "authorization_user_agent" : "DEFAULT",
  "redirect_uri" : "msauth://com.azuresamples.msalandroidapp/1wIqXSqBj7w%2Bh11ZifsnqwgyKrY%3D",
  "broker_redirect_uri_registered": true,
  "authorities" : [
    {
      "type": "AAD",
      "audience": {
        "type": "AzureADandPersonalMicrosoftAccount",
        "tenant_id": "common"
      }
    }
  ]
}
```

## Next steps

### Learn the steps to create the application used in this quickstart

Try out the Android tutorial for a complete step-by-step guide on building applications and new features, including a full explanation of this quickstart.

> [!div class="nextstepaction"]
> [Call Graph API Android tutorial](https://docs.microsoft.com/azure/active-directory/develop/guidedsetups/active-directory-android)

### MSAL for Android library wiki

Read more information about MSAL library for Android:

> [!div class="nextstepaction"]
> [MSAL for Android library wiki](https://github.com/AzureAD/microsoft-authentication-library-for-android/wiki)

[!INCLUDE [Help and support](../../../includes/active-directory-develop-help-support-include.md)]

Help us improve the Microsoft identity platform. Tell us what you think by completing a short two-question survey.

> [!div class="nextstepaction"]
> [Microsoft identity platform survey](https://forms.office.com/Pages/ResponsePage.aspx?id=v4j5cvGGr0GRqy180BHbRyKrNDMV_xBIiPGgSvnbQZdUQjFIUUFGUE1SMEVFTkdaVU5YT0EyOEtJVi4u)